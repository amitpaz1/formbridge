# FormBridge Code Review Remediation — Sprint Status
# Generated: 2026-02-06
# Source: tech-spec-formbridge-review-fixes.md

sprint:
  name: "FormBridge Review Remediation"
  created: "2026-02-06"
  status: "complete"
  total_stories: 20
  completed: 20
  in_progress: 0

epics:
  - id: epic-1
    name: "Security Hardening"
    priority: critical
    status: done
    stories:
      - id: story-1.1
        name: "Timing-Safe Resume Token Comparison"
        priority: critical
        effort: small
        status: done
        files:
          - src/core/errors.ts
          - src/core/approval-manager.ts
          - src/core/submission-manager.ts
        depends_on: []
        notes: "Added timingSafeTokenCompare utility; updated 7 call sites"

      - id: story-1.2
        name: "Add Auth Middleware to Analytics and Webhook Routes"
        priority: critical
        effort: small
        status: done
        files:
          - src/middleware/auth.ts  # NEW
          - src/app.ts
        depends_on: []
        notes: "API key guard on /analytics/* and /webhooks/*"

      - id: story-1.3
        name: "Validate intakeId Path Parameter in Submit Route"
        priority: high
        effort: small
        status: done
        files:
          - src/routes/hono-submissions.ts
        depends_on: []
        notes: "Check submission.intakeId matches URL param before submit"

  - id: epic-2
    name: "Type System Cleanup"
    priority: high
    status: done
    stories:
      - id: story-2.1
        name: "Split IntakeError into Discriminated Unions"
        priority: high
        effort: medium
        status: done
        files:
          - src/types/intake-contract.ts
          - src/mcp/response-builder.ts
          - src/core/approval-manager.ts
          - src/core/submission-manager.ts
          - src/middleware/error-handler.ts
          - src/routes/hono-approvals.ts
          - src/routes/hono-submissions.ts
        depends_on: []
        notes: "IntakeErrorEnvelope + IntakeErrorFlat = IntakeError union with type guards"

      - id: story-2.2
        name: "Split SubmissionState into Core vs MCP States"
        priority: high
        effort: small
        status: done
        files:
          - src/types/intake-contract.ts
        depends_on: []
        notes: "CoreSubmissionState (11 states) + MCPSessionState = backward-compatible union"

      - id: story-2.3
        name: "Rename MCP SubmissionStore to MCPSessionStore"
        priority: medium
        effort: small
        status: done
        files:
          - src/mcp/submission-store.ts
          - src/mcp/server.ts
          - src/mcp/response-builder.ts
          - src/mcp/handlers/create-handler.ts
          - src/mcp/handlers/set-handler.ts
          - src/mcp/handlers/submit-handler.ts
          - src/mcp/handlers/upload-handlers.ts
          - src/mcp/handlers/validate-handler.ts
        depends_on: []
        notes: "Renamed class + all imports across 8 files"

  - id: epic-3
    name: "Architecture Improvements"
    priority: medium
    status: done
    stories:
      - id: story-3.1
        name: "Extract Helper Classes from app.ts"
        priority: medium
        effort: medium
        status: done
        files:
          - src/app.ts
          - src/core/bridging-event-emitter.ts  # NEW
          - src/core/expiry-scheduler.ts  # NEW
          - src/core/webhook-notifier-impl.ts  # NEW
        depends_on: []
        notes: "Extracted 3 classes, app.ts 834→739 lines (-95)"

      - id: story-3.2
        name: "SubmissionManager Constructor Options Object"
        priority: medium
        effort: small
        status: done
        files:
          - src/core/submission-manager.ts
          - src/app.ts
          - src/core/__tests__/submission-manager.test.ts
          - tests/hono-routes.test.ts
          - tests/pagination.test.ts
          - tests/upload-negotiation.test.ts
          - tests/integration/agent-handoff.test.ts
          - tests/integration/approval-workflow.test.ts
          - tests/integration/event-stream.test.ts
          - tests/routes/hono-submissions-extra.test.ts
          - tests/routes/hono-events-extra.test.ts
        depends_on: []
        notes: "Replaced 6 positional params with SubmissionManagerOptions; 18 call sites updated"

      - id: story-3.3
        name: "Deduplicate ApprovalManager Validation Logic"
        priority: low
        effort: small
        status: done
        files:
          - src/core/approval-manager.ts
        depends_on:
          - story-1.1
        notes: "Extracted validateReviewRequest helper; uses timingSafeTokenCompare from 1.1"

  - id: epic-4
    name: "Performance Fixes"
    priority: medium
    status: done
    stories:
      - id: story-4.1
        name: "Rate Limiter Automatic Cleanup"
        priority: high
        effort: small
        status: done
        files:
          - src/auth/rate-limiter.ts
        depends_on: []
        notes: "Piggyback cleanup every 100th check() call"

      - id: story-4.2
        name: "Single-Query Pagination for Event Routes"
        priority: medium
        effort: medium
        status: done
        files:
          - src/core/event-store.ts
          - src/storage/sqlite-storage.ts
          - src/core/submission-manager.ts
          - src/routes/hono-events.ts
        depends_on: []
        notes: "Added countEvents(); parallel count + paginated fetch"

      - id: story-4.3
        name: "Validator Schema Cache via WeakMap"
        priority: low
        effort: small
        status: done
        files:
          - src/core/validator.ts
        depends_on: []
        notes: "WeakMap first-level cache; skips JSON.stringify on ref hit"

      - id: story-4.4
        name: "Fix SQLite LIMIT/OFFSET Construction"
        priority: medium
        effort: small
        status: done
        files:
          - src/storage/sqlite-storage.ts
        depends_on: []
        notes: "Parameterized LIMIT/OFFSET; handles OFFSET-without-LIMIT"

  - id: epic-5
    name: "Quick Wins"
    priority: low
    status: done
    stories:
      - id: story-5.1
        name: "Remove Stale .d.ts Files"
        priority: low
        effort: trivial
        status: done
        files:
          - src/types/intake-contract.d.ts  # DELETED
          - src/core/step-validator.d.ts  # DELETED
          - src/core/condition-evaluator.d.ts  # DELETED
          - src/submission-types.d.ts  # DELETED
        depends_on: []
        notes: "4 stale build artifacts removed"

      - id: story-5.2
        name: "Move test-server.ts Out of src/"
        priority: low
        effort: trivial
        status: done
        files:
          - tests/test-server.ts  # MOVED from src/
        depends_on: []
        notes: "Dev file moved out of production source"

      - id: story-5.3
        name: "Log Swallowed Errors in Webhook processDelivery"
        priority: medium
        effort: trivial
        status: done
        files:
          - src/core/webhook-manager.ts
        depends_on: []
        notes: "Empty .catch() → console.error logging"

      - id: story-5.4
        name: "Fix ESM Imports in Schema Normalizer"
        priority: low
        effort: small
        status: done
        files:
          - packages/schema-normalizer/src/index.ts
        depends_on: []
        notes: "Removed require() factory functions; use direct imports"

      - id: story-5.5
        name: "Consistent HTTP Status for InvalidResumeTokenError in Approvals"
        priority: low
        effort: trivial
        status: done
        files:
          - src/routes/hono-approvals.ts
          - tests/routes/hono-approvals.test.ts
        depends_on: []
        notes: "403 → 409 in 3 catch blocks + test expectations"

      - id: story-5.6
        name: "Add Missing Event Types to Zod Enum"
        priority: low
        effort: trivial
        status: done
        files:
          - src/routes/hono-events.ts
        depends_on: []
        notes: "Added fields.updated, step.started, step.completed, step.validation_failed"

      - id: story-5.7
        name: "Event Store — Clone Event Before Mutating Version"
        priority: low
        effort: trivial
        status: done
        files:
          - src/core/event-store.ts
        depends_on: []
        notes: "Spread-clone before version assignment; preserves immutability"
